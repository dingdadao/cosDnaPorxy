# 🚀 DNS 代理优化指南

## 📋 已完成的优化

### 1. **DNS 分流逻辑优化**

- ✅ **修复处理顺序问题**：白名单 → 定向域名 → 地理位置分流 → DNS 查询 → 云服务检测
- ✅ **避免不必要的上游查询**：定向域名检查提前到 DNS 查询之前
- ✅ **增加详细日志**：每个处理步骤都有对应的调试日志

### 2. **Geosite 匹配逻辑改进**

- ✅ **完整匹配检查**：确保所有匹配规则都被检查，而不是找到第一个就返回
- ✅ **增强错误处理**：正则匹配失败时提供详细错误信息
- ✅ **改进日志输出**：匹配成功/失败都有详细日志记录

### 3. **DNS 查询性能优化**

- ✅ **智能服务器选择**：并发查询多个 DNS 服务器，选择最快响应
- ✅ **健康检查机制**：定期检查 DNS 服务器健康状态
- ✅ **超时优化**：增加查询超时时间，提高稳定性
- ✅ **错误处理增强**：更详细的错误信息和重试机制

### 4. **域名匹配算法优化**

- ✅ **支持更多匹配模式**：完全匹配、前缀通配符、后缀通配符、模糊通配符
- ✅ **性能优化**：正则表达式预编译，避免重复编译
- ✅ **边界情况处理**：避免空字符串和无效模式

### 5. **配置优化**

- ✅ **多 DNS 服务器支持**：国内 DNS 增加多个备选服务器
- ✅ **详细配置说明**：每个配置项都有注释说明
- ✅ **推荐配置**：提供经过测试的推荐 DNS 服务器列表

## 🔧 使用建议

### 1. **DNS 服务器配置**

```yaml
# 推荐国内DNS组合
cn_upstream:
  - "119.29.29.29:53" # 腾讯DNS - 稳定性好
  - "223.5.5.5:53" # 阿里DNS - 速度快
  - "114.114.114.114:53" # 114DNS - 备用
  - "180.76.76.76:53" # 百度DNS - 备用

# 推荐国外DNS组合
not_cn_upstream:
  - "8.8.8.8:53" # Google DNS - 稳定性好
  - "1.1.1.1:53" # Cloudflare DNS - 速度快
  - "208.67.222.222:53" # OpenDNS - 备用
```

### 2. **白名单配置示例**

```txt
# 白名单域名 - 这些域名不会被任何处理
*.baidu.com
*.qq.com
*.taobao.com
*.alipay.com
```

### 3. **定向域名配置示例**

```txt
# 格式：域名 DNS服务器
*.google.com 8.8.8.8:53
*.github.com 1.1.1.1:53
*.microsoft.com 208.67.222.222:53
```

### 4. **监控和调试**

- 启用 `log_level: "debug"` 查看详细处理过程
- 使用 Prometheus 指标监控查询性能和成功率
- 定期检查日志文件中的错误信息

## 🐛 常见问题排查

### 1. **中国大陆域名解析错误**

**可能原因：**

- Geosite 数据未正确加载
- 上游 DNS 服务器不可用
- 域名匹配规则配置错误

**排查步骤：**

1. 检查 `geosite.dat` 文件是否存在且有效
2. 验证上游 DNS 服务器连通性
3. 查看调试日志中的匹配过程

### 2. **DNS 查询超时**

**可能原因：**

- 上游 DNS 服务器响应慢
- 网络连接问题
- 并发查询配置不当

**解决方案：**

1. 增加更多备用 DNS 服务器
2. 调整查询超时时间
3. 检查网络连接质量

### 3. **缓存命中率低**

**可能原因：**

- 缓存配置不当
- 缓存大小不足
- 缓存 TTL 设置过短

**优化建议：**

1. 增加缓存大小：`MaxCost: 1 << 20`
2. 调整缓存 TTL：`replace_cache_time: "30m"`
3. 监控缓存命中率指标

## 📊 性能监控指标

### 关键指标

- `dns_queries_total` - 总查询数（按类型和状态分类）
- `upstream_query_latency_seconds` - 上游查询延迟
- `cache_hits_total` - 缓存命中次数
- `whitelist_hits_total` - 白名单命中次数
- `designated_hits_total` - 定向域名命中次数
- `replaced_records_total` - 替换记录总数

### 监控建议

1. 设置查询延迟告警（>2 秒）
2. 监控缓存命中率（目标>80%）
3. 跟踪 DNS 服务器健康状态
4. 关注错误率变化

## 🔄 定期维护

### 1. **数据更新**

- Geosite 数据：每 72 小时自动更新
- Cloudflare IP 列表：每 24 小时检查更新
- AWS IP 列表：根据 AWS 官方更新频率

### 2. **日志清理**

- 定期清理旧日志文件
- 监控日志文件大小
- 设置日志轮转策略

### 3. **性能调优**

- 根据实际使用情况调整缓存大小
- 优化 DNS 服务器列表
- 调整查询超时时间

## 🎯 最佳实践

1. **多 DNS 服务器**：配置多个上游 DNS 服务器提高可靠性
2. **健康检查**：定期检查 DNS 服务器状态
3. **缓存优化**：合理设置缓存大小和 TTL
4. **监控告警**：设置关键指标告警
5. **日志管理**：合理配置日志级别和轮转
6. **安全考虑**：使用 DoH/DoT 加密 DNS 查询
7. **备份配置**：定期备份配置文件和数据

## 📞 故障排除

如果遇到问题，请按以下步骤排查：

1. **检查日志**：查看详细的调试日志
2. **验证配置**：确认配置文件格式正确
3. **测试连通性**：验证上游 DNS 服务器可达性
4. **检查资源**：确认系统资源充足
5. **查看指标**：分析 Prometheus 监控指标

---

_最后更新：2024 年 12 月_
