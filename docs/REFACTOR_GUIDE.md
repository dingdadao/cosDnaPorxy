# 🔄 项目重构指南

## 📁 新的项目结构

```
cosDnaPorxy/
├── main.go                    # 主入口文件（简化版）
├── config.yaml               # 配置文件
├── internal/                 # 内部模块
│   ├── config/              # 配置管理
│   │   └── config.go        # 配置结构体和加载逻辑
│   ├── dns/                 # DNS核心功能
│   │   ├── handler.go       # DNS处理器核心逻辑
│   │   ├── server.go        # DNS服务器启动逻辑
│   │   └── types.go         # DNS相关类型定义
│   ├── geosite/             # 地理位置管理
│   │   └── manager.go       # Geosite数据管理
│   ├── metrics/             # 监控指标
│   │   └── collector.go     # Prometheus指标收集
│   └── utils/               # 工具函数
│       ├── domain.go        # 域名处理工具
│       ├── errors.go        # 错误处理工具
│       └── logger.go        # 日志工具
├── v2ray.com/               # V2Ray协议相关（保持不变）
├── shell/                   # 脚本文件（保持不变）
└── 其他文件...              # 配置文件等（保持不变）
```

## 🎯 重构目标

### ✅ 已完成的重构

1. **模块化拆分**

   - 将 1600+行的 main.go 拆分为多个独立模块
   - 每个模块职责单一，便于维护
   - 清晰的包结构和依赖关系

2. **配置管理优化**

   - 独立的配置模块
   - 配置验证和默认值处理
   - 更好的错误处理

3. **DNS 功能模块化**

   - 核心处理器逻辑独立
   - 服务器启动逻辑分离
   - 类型定义集中管理

4. **工具函数整理**

   - 域名匹配算法独立
   - 错误处理统一
   - 日志功能模块化

5. **监控指标独立**
   - Prometheus 指标收集独立模块
   - 指标注册和管理
   - 监控服务器启动

## 🔧 模块说明

### 1. **config 模块** (`internal/config/`)

- **职责**: 配置文件的加载、验证和管理
- **主要功能**:
  - 配置结构体定义
  - 配置文件解析
  - 配置验证
  - 默认值设置

### 2. **dns 模块** (`internal/dns/`)

- **职责**: DNS 处理的核心逻辑
- **主要功能**:
  - DNS 请求处理
  - 上游 DNS 查询
  - 域名分流逻辑
  - 云服务检测和替换
  - 服务器健康检查

### 3. **geosite 模块** (`internal/geosite/`)

- **职责**: 地理位置数据管理
- **主要功能**:
  - Geosite 数据下载和缓存
  - 域名地理位置匹配
  - 数据更新管理

### 4. **metrics 模块** (`internal/metrics/`)

- **职责**: 监控指标收集
- **主要功能**:
  - Prometheus 指标定义
  - 指标注册和管理
  - 监控服务器启动

### 5. **utils 模块** (`internal/utils/`)

- **职责**: 通用工具函数
- **主要功能**:
  - 域名匹配算法
  - 错误处理
  - 日志记录

## 🚀 使用方式

### 编译和运行

```bash
# 编译
go build -o dnsproxy main.go

# 运行
./dnsproxy -c config.yaml
```

### 开发调试

```bash
# 直接运行
go run main.go -c config.yaml

# 调试模式
go run -race main.go -c config.yaml
```

## 📊 代码质量提升

### 1. **可维护性**

- 模块职责清晰，便于定位问题
- 代码结构合理，易于理解
- 减少代码重复

### 2. **可测试性**

- 每个模块可以独立测试
- 依赖注入，便于 mock
- 清晰的接口定义

### 3. **可扩展性**

- 模块化设计，便于添加新功能
- 清晰的依赖关系
- 标准化的接口

### 4. **性能优化**

- 保持了原有的性能优化
- 并发查询机制
- 缓存机制
- 健康检查

## 🔍 迁移指南

### 从旧版本迁移

1. **配置文件**: 无需修改，保持兼容
2. **运行方式**: 保持不变
3. **功能特性**: 完全保持

### 开发新功能

1. **添加新模块**: 在`internal/`下创建新目录
2. **修改配置**: 在`config.go`中添加新字段
3. **添加指标**: 在`metrics/collector.go`中定义
4. **更新文档**: 及时更新相关文档

## 🛠 开发建议

### 1. **代码规范**

- 遵循 Go 语言规范
- 使用有意义的包名和函数名
- 添加适当的注释

### 2. **错误处理**

- 使用统一的错误类型
- 提供有意义的错误信息
- 适当的错误日志记录

### 3. **测试**

- 为每个模块编写单元测试
- 测试覆盖率要求
- 集成测试验证

### 4. **文档**

- 及时更新文档
- 添加代码注释
- 维护示例代码

## 📈 后续优化方向

1. **配置热重载**: 支持运行时配置更新
2. **插件系统**: 支持自定义 DNS 处理逻辑
3. **API 接口**: 提供 REST API 进行管理
4. **集群支持**: 支持多实例部署
5. **更多协议**: 支持更多 DNS 协议

---

_重构完成时间: 2024 年 12 月_
