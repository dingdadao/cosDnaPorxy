# 内存优化指南

## 问题分析

经过代码分析，发现以下主要内存泄漏问题：

### 1. 标签系统内存泄漏 🔴

- **问题**: `TagMapSimple` 全局变量无限增长，每次查询域名都会添加新标签
- **影响**: 长期运行后可能导致内存溢出
- **修复**: 添加内存限制、定期清理过期标签

### 2. 异步刷新通道阻塞 🔴

- **问题**: 异步刷新通道缓冲区只有 1000，容易满导致阻塞
- **影响**: 可能造成 goroutine 泄漏和内存增长
- **修复**: 增加缓冲区大小，添加任务过期检查

### 3. 连接池资源泄漏 🟡

- **问题**: 连接池中的连接可能没有正确关闭
- **影响**: 连接资源累积，内存增长
- **修复**: 添加连接超时检查，定期清理旧连接

### 4. 缓存配置不当 🟡

- **问题**: 缓存最大成本设置过低，驱逐率过高
- **影响**: 缓存效率低，频繁重建
- **修复**: 优化缓存配置，增加内存限制

## 优化措施

### 1. 标签系统优化

```go
// 限制标签map最大大小
maxTagMapSize = 100000

// 定期清理过期标签（24小时）
func cleanupExpiredTags()

// 定期刷新标签到文件，释放内存
func periodicTagCleanup()
```

### 2. 缓存系统优化

```go
// 增加缓存最大成本到100MB
MaxCost: 100 << 20

// 增加计数器数量
NumCounters: 1000

// 更频繁的缓存清理（每2分钟）
func aggressiveCacheCleanup()
```

### 3. 连接池优化

```go
// 增加连接池大小限制
maxConns: 10
maxClients: 10

// 添加连接超时检查
timeout: 30 * time.Second

// 定期清理旧连接
func cleanupOldConnections()
```

### 4. 异步刷新优化

```go
// 增加通道缓冲区
asyncRefreshChan: make(chan *AsyncRefreshTask, 5000)

// 增加工作线程数
maxWorkers: 10

// 添加任务过期检查
if time.Now().After(task.ExpireTime) {
    // 跳过过期任务
}
```

### 5. 内存监控系统

```go
// 实时内存监控
func StartMemoryMonitor()

// 自动内存清理
func triggerMemoryCleanup()

// 强制垃圾回收
func ForceGC()
```

## 监控指标

### 内存使用监控

- 当前分配内存
- 系统分配内存
- 堆对象数量
- GC 次数

### 标签系统监控

- 标签 map 大小
- 过期标签数量
- 清理频率

### 缓存系统监控

- 缓存命中率
- 驱逐率
- 缓存大小

## 配置建议

### 缓存配置

```yaml
cache:
  max_size: "200MB" # 增加缓存大小
  dns_ttl_min: "5m" # 减少最小TTL
  dns_ttl_max: "2h" # 增加最大TTL
  enable_async_refresh: true # 启用异步刷新
  max_async_workers: 10 # 增加工作线程数
```

### 连接池配置

```yaml
# 连接池优化
dot_pool:
  max_conns: 10
  timeout: "30s"

doh_pool:
  max_clients: 10
  timeout: "30s"
```

## 运行建议

### 1. 定期重启

- 建议每 24 小时重启一次服务
- 使用 systemd 的 RestartSec 配置

### 2. 内存限制

- 设置容器内存限制（如 Docker）
- 监控系统内存使用情况

### 3. 日志监控

- 关注内存监控日志
- 监控标签清理日志
- 关注缓存统计信息

## 性能影响

### 正面影响

- 内存使用更稳定
- 减少内存泄漏风险
- 更好的资源管理

### 负面影响

- 轻微的性能开销（监控和清理）
- 偶尔的缓存清理可能影响响应时间

## 故障排除

### 内存仍然增长

1. 检查标签系统大小
2. 查看缓存统计
3. 检查 goroutine 数量
4. 强制触发内存清理

### 性能下降

1. 调整缓存大小
2. 优化 TTL 配置
3. 检查连接池配置
4. 监控异步刷新频率

## 总结

通过以上优化措施，可以有效解决内存泄漏问题：

1. **标签系统**: 添加大小限制和过期清理
2. **缓存系统**: 优化配置和清理策略
3. **连接池**: 改进资源管理和超时处理
4. **异步刷新**: 增加缓冲区和错误处理
5. **内存监控**: 实时监控和自动清理

这些优化确保了系统在长期运行时的内存稳定性，同时保持了良好的性能表现。
