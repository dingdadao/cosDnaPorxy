# DoT (DNS over TLS) 功能说明

## 概述

本项目现在支持 DoT (DNS over TLS) 协议，这是一种通过 TLS 加密传输 DNS 查询的安全协议。相比传统的 UDP DNS 查询，DoT 提供了更好的隐私保护和安全性。

## 支持的协议

- **UDP**: 传统 DNS 查询 (端口 53)
- **TCP**: TCP DNS 查询 (端口 53)
- **DoT**: DNS over TLS (端口 853)
- **DoH**: DNS over HTTPS (端口 443)

## 配置方法

### 1. 基本配置

在 `config.yaml` 中配置 DoT 上游服务器：

```yaml
# 国内上游DNS服务器
cn_upstream:
  - "223.5.5.5:53" # 阿里DNS (UDP)
  - "tls://223.5.5.5:853" # 阿里DNS DoT
  - "tls://119.29.29.29:853" # 腾讯DNS DoT

# 国外上游DNS服务器
not_cn_upstream:
  - "8.8.8.8:53" # Google DNS (UDP)
  - "tls://8.8.8.8:853" # Google DNS DoT
  - "tls://1.1.1.1:853" # Cloudflare DNS DoT
  - "https://dns.google/dns-query" # Google DoH
```

### 2. DoT 服务器地址格式

```
tls://[IP地址]:[端口]
```

- 如果未指定端口，将自动使用默认端口 853
- 支持 IPv4 和 IPv6 地址

### 3. 推荐的 DoT 服务器

#### 国内服务器

- **阿里 DNS**: `tls://223.5.5.5:853`
- **腾讯 DNS**: `tls://119.29.29.29:853`
- **114DNS**: `tls://114.114.114.114:853`

#### 国外服务器

- **Google DNS**: `tls://8.8.8.8:853`
- **Cloudflare**: `tls://1.1.1.1:853`
- **Quad9**: `tls://9.9.9.9:853`

## 功能特性

### 1. 自动协议选择

系统会根据配置的协议前缀自动选择查询方式：

- `tls://` → DoT 查询
- `https://` → DoH 查询
- `tcp://` → TCP DNS 查询
- `udp://` → UDP DNS 查询
- 无前缀 → UDP DNS 查询

### 2. 并发查询

支持同时配置多种协议的上游服务器，系统会并发查询并选择最快的有效响应。

### 3. 健康检查

定期检查 DoT 服务器的连接状态，自动跳过不健康的服务器。

### 4. TLS 安全配置

- 强制使用 TLS 1.2 或更高版本
- 验证服务器证书
- 5 秒查询超时

## 使用示例

### 1. 启动服务

```bash
./dnsupdate
```

### 2. 测试 DoT 功能

```bash
# 测试脚本
./test_dot.sh

# 手动测试
dig @127.0.0.1:5354 google.com A
dig @127.0.0.1:5354 github.com AAAA
```

### 3. 查看日志

```bash
# 查看 DoT 查询日志
tail -f logs/dns.log | grep "DoT"
```

## 故障排除

### 1. 连接超时

- 检查防火墙是否阻止 853 端口
- 确认 DoT 服务器地址正确
- 检查网络连接

### 2. TLS 握手失败

- 确认服务器支持 TLS 1.2+
- 检查系统时间是否正确
- 尝试其他 DoT 服务器

### 3. 查询失败

- 检查 DNS 代理是否正常运行
- 查看错误日志
- 确认上游服务器配置

## 性能优化

### 1. 混合配置

建议同时配置 UDP 和 DoT 服务器：

- UDP 服务器响应快，适合简单查询
- DoT 服务器安全，适合敏感查询

### 2. 超时设置

- UDP: 3 秒
- TCP: 3 秒
- DoT: 5 秒
- DoH: 5 秒

### 3. 并发查询

系统会自动并发查询多个上游服务器，选择最快的有效响应。

## 安全考虑

1. **证书验证**: 系统会验证 DoT 服务器的 TLS 证书
2. **协议版本**: 强制使用 TLS 1.2+ 版本
3. **超时保护**: 防止长时间连接占用资源
4. **错误处理**: 自动跳过有问题的服务器

## 更新日志

- **v1.0**: 基础 DoT 支持
- **v1.1**: 改进 TLS 配置和错误处理
- **v1.2**: 添加健康检查和并发查询优化

## 技术支持

如果遇到问题，请：

1. 查看日志文件
2. 运行测试脚本
3. 检查配置文件
4. 提交 Issue 到项目仓库
